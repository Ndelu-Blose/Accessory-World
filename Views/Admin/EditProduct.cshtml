@model AccessoryWorld.ViewModels.EditProductViewModel
@{
    ViewData["Title"] = "Edit Product";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
<style>
    :root {
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --accent: #7c3aed;
        --accent-magenta: #d946ef;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #06b6d4;
        --text-dark: #1f2937;
        --text-muted: #6b7280;
        --bg-light: #f8fafc;
        --border: #e5e7eb;
        --border-radius: 12px;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .admin-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 100vh;
        padding: 2rem;
    }

    .admin-sidebar {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        position: sticky;
        top: 2rem;
        height: fit-content;
    }

    .admin-sidebar .sidebar-header {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        color: white;
        padding: 1.5rem;
        text-align: center;
    }

    .admin-sidebar .sidebar-header h5 {
        margin: 0;
        font-weight: 700;
        font-size: 1.1rem;
    }

    .admin-nav {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .admin-nav-item {
        border-bottom: 1px solid var(--border);
    }

    .admin-nav-item:last-child {
        border-bottom: none;
    }

    .admin-nav-link {
        display: flex;
        align-items: center;
        padding: 1rem 1.5rem;
        color: var(--text-dark);
        text-decoration: none;
        transition: all 0.2s ease;
        font-weight: 500;
    }

    .admin-nav-link:hover {
        background: var(--bg-light);
        color: var(--primary);
        text-decoration: none;
    }

    .admin-nav-link.active {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        color: white;
    }

    .admin-nav-link i {
        width: 20px;
        margin-right: 0.75rem;
        text-align: center;
    }

    .admin-content {
        padding: 0;
    }

    .admin-content-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        border: none;
        margin-bottom: 1.5rem;
    }

    .card {
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border);
    }

    .card-header {
        background: var(--bg-light);
        border-bottom: 1px solid var(--border);
        border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
        padding: 1rem 1.5rem;
    }

    .card-header h4, .card-header h5 {
        color: var(--text-dark);
        font-weight: 600;
        margin: 0;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1.5rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-dark), var(--primary));
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-secondary {
        background: #6c757d;
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1.5rem;
        font-weight: 500;
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--danger), #dc2626);
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1.5rem;
        font-weight: 500;
    }

    .btn-info {
        background: linear-gradient(135deg, var(--info), #0891b2);
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1.5rem;
        font-weight: 500;
    }

    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid var(--border);
        padding: 0.75rem;
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
    }

    .form-label {
        color: var(--text-dark);
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .input-group-text {
        background: var(--bg-light);
        border: 1px solid var(--border);
        color: var(--text-muted);
    }

    .badge {
        border-radius: 6px;
        font-weight: 500;
    }

    .text-primary {
        color: var(--primary) !important;
    }

    .text-success {
        color: var(--success) !important;
    }

    .text-muted {
        color: var(--text-muted) !important;
    }

    #imageUploadArea {
        border: 2px dashed var(--border) !important;
        border-radius: var(--border-radius);
        transition: all 0.3s ease;
    }

    #imageUploadArea:hover {
        border-color: var(--primary) !important;
        background-color: var(--bg-light);
    }

    .modal-content {
        border-radius: var(--border-radius);
        border: none;
        box-shadow: var(--shadow-lg);
    }

    .modal-header {
        background: var(--bg-light);
        border-bottom: 1px solid var(--border);
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .alert-warning {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.2);
        color: #92400e;
        border-radius: 8px;
    }
</style>
}

<div class="admin-container">
    <div class="row">
        <div class="col-md-3">
            <!-- Admin Navigation Sidebar -->
            <div class="admin-sidebar">
                <div class="sidebar-header">
                    <h5><i class="fas fa-tachometer-alt me-2"></i>Admin Panel</h5>
                </div>
                <nav>
                    <ul class="admin-nav">
                        <li class="admin-nav-item">
                            <a href="@Url.Action("Dashboard", "Admin")" class="admin-nav-link">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li class="admin-nav-item">
                            <a href="@Url.Action("Products", "Admin")" class="admin-nav-link active">
                                <i class="fas fa-box"></i>
                                <span>Products</span>
                            </a>
                        </li>
                        <li class="admin-nav-item">
                            <a href="@Url.Action("Orders", "Admin")" class="admin-nav-link">
                                <i class="fas fa-shopping-cart"></i>
                                <span>Orders</span>
                            </a>
                        </li>
                        <li class="admin-nav-item">
                            <a href="@Url.Action("Users", "Admin")" class="admin-nav-link">
                                <i class="fas fa-users"></i>
                                <span>Users</span>
                            </a>
                        </li>
                        <li class="admin-nav-item">
                            <a href="@Url.Action("Inventory", "Admin")" class="admin-nav-link">
                                <i class="fas fa-warehouse"></i>
                                <span>Inventory</span>
                            </a>
                        </li>
                        <li class="admin-nav-item">
                            <a href="@Url.Action("Reports", "Admin")" class="admin-nav-link">
                                <i class="fas fa-chart-bar"></i>
                                <span>Reports</span>
                            </a>
                        </li>
                        <li class="admin-nav-item">
                            <a href="@Url.Action("Settings", "Admin")" class="admin-nav-link">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9">
            <div class="admin-content">
<div class="admin-content-card">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Edit Product: @Model.Name</h4>
                    <div>
                        <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button type="button" class="btn btn-danger" onclick="deleteProduct()">
                            <i class="fas fa-trash"></i> Delete Product
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <form id="editProductForm" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Id" />
                        
                        <div class="row">
                            <!-- Basic Information -->
                            <div class="col-lg-8">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Basic Information</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label asp-for="Name" class="form-label">Product Name *</label>
                                                    <input asp-for="Name" class="form-control" placeholder="Enter product name" required />
                                                    <span asp-validation-for="Name" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label asp-for="SKUCode" class="form-label">SKU Code *</label>
                                                    <input asp-for="SKUCode" class="form-control" placeholder="Enter SKU code" required />
                                                    <span asp-validation-for="SKUCode" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label asp-for="CategoryId" class="form-label">Category *</label>
                                                    <select asp-for="CategoryId" class="form-select" required>
                                                        <option value="">Select Category</option>
                                                        <option value="1">Gaming Accessories</option>
                                                        <option value="2">Mobile Accessories</option>
                                                        <option value="3">Computer Accessories</option>
                                                        <option value="4">Audio & Video</option>
                                                        <option value="5">Cables & Adapters</option>
                                                    </select>
                                                    <span asp-validation-for="CategoryId" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label asp-for="BrandId" class="form-label">Brand *</label>
                                                    <select asp-for="BrandId" class="form-select" required>
                                                        <option value="">Select Brand</option>
                                                        @foreach (var brand in (ViewBag.Brands as IEnumerable<dynamic>) ?? Enumerable.Empty<dynamic>())
                                                        {
                                                            <option value="@brand.Id">@brand.Name</option>
                                                        }
                                                    </select>
                                                    <span asp-validation-for="BrandId" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group mb-3">
                                            <label asp-for="Description" class="form-label">Description</label>
                                            <textarea asp-for="Description" class="form-control" rows="4" placeholder="Enter product description"></textarea>
                                            <span asp-validation-for="Description" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pricing & Promotions -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Pricing & Promotions</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group mb-3">
                                                    <label asp-for="Price" class="form-label">Regular Price *</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">R</span>
                                                        <input asp-for="Price" type="number" step="0.01" class="form-control" placeholder="0.00" required />
                                                    </div>
                                                    <span asp-validation-for="Price" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group mb-3">
                                                    <label asp-for="CompareAtPrice" class="form-label">Compare At Price</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">R</span>
                                                        <input asp-for="CompareAtPrice" type="number" step="0.01" class="form-control" placeholder="0.00" />
                                                    </div>
                                                    <span asp-validation-for="CompareAtPrice" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group mb-3">
                                                    <label asp-for="SalePrice" class="form-label">Sale Price</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">R</span>
                                                        <input asp-for="SalePrice" type="number" step="0.01" class="form-control" placeholder="0.00" />
                                                    </div>
                                                    <span asp-validation-for="SalePrice" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check mb-3">
                                                    <input asp-for="IsOnSale" class="form-check-input" type="checkbox" />
                                                    <label asp-for="IsOnSale" class="form-check-label">Product is on sale</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div id="salePercentage" class="text-muted small" style="display: none;">
                                                    Sale: <span id="salePercent">0</span>% off
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Inventory Management -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Inventory Management</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label asp-for="StockQuantity" class="form-label">Stock Quantity *</label>
                                                    <input asp-for="StockQuantity" type="number" class="form-control" placeholder="0" required />
                                                    <span asp-validation-for="StockQuantity" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label asp-for="LowStockThreshold" class="form-label">Low Stock Threshold</label>
                                                    <input asp-for="LowStockThreshold" type="number" class="form-control" placeholder="5" />
                                                    <span asp-validation-for="LowStockThreshold" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label asp-for="Condition" class="form-label">Condition</label>
                                                    <select asp-for="Condition" class="form-select">
                                                        <option value="New">New</option>
                                                        <option value="Refurbished">Refurbished</option>
                                                        <option value="Used">Used</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check mt-4">
                                                    <input asp-for="InStock" class="form-check-input" type="checkbox" />
                                                    <label asp-for="InStock" class="form-check-label">In Stock</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Product Images & Features -->
                            <div class="col-lg-4">
                                <!-- Product Images -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Product Images</h5>
                                    </div>
                                    <div class="card-body">
                                        <!-- Current Images -->
                                        <div id="currentImages" class="mb-3">
                                            <h6>Current Images</h6>
                                            <div id="currentImagesList" class="row">
                                                <!-- Current images will be loaded here -->
                                            </div>
                                        </div>
                                        
                                        <!-- Image Upload Area -->
                                        <div id="imageUploadArea" class="border border-dashed border-2 p-4 text-center mb-3" style="border-color: #dee2e6; cursor: pointer;">
                                            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                            <p class="mb-1">Drag & drop images here or click to browse</p>
                                            <small class="text-muted">JPG, PNG, WebP up to 5MB each</small>
                                            <input type="file" id="imageInput" multiple accept=".jpg,.jpeg,.png,.webp" style="display: none;" />
                                        </div>
                                        
                                        <!-- Image Preview -->
                                        <div id="imagePreview" class="row"></div>
                                    </div>
                                </div>

                                <!-- Product Features -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Product Features</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input asp-for="IsFeatured" class="form-check-input" type="checkbox" />
                                            <label asp-for="IsFeatured" class="form-check-label">Featured Product</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input asp-for="IsNew" class="form-check-input" type="checkbox" />
                                            <label asp-for="IsNew" class="form-check-label">New Product</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input asp-for="IsHot" class="form-check-input" type="checkbox" />
                                            <label asp-for="IsHot" class="form-check-label">Hot Product</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input asp-for="IsTodayDeal" class="form-check-input" type="checkbox" />
                                            <label asp-for="IsTodayDeal" class="form-check-label">Today's Deal</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input asp-for="IsBestSeller" class="form-check-input" type="checkbox" />
                                            <label asp-for="IsBestSeller" class="form-check-label">Best Seller</label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                                            <label asp-for="IsActive" class="form-check-label">Active Status</label>
                                        </div>
                                        
                                        <!-- Tags -->
                                        <div class="form-group">
                                            <label asp-for="Tags" class="form-label">Tags</label>
                                            <input asp-for="Tags" class="form-control" placeholder="gaming, wireless, bluetooth" />
                                            <small class="text-muted">Separate tags with commas</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Product Stats -->
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Product Statistics</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <div class="border-end">
                                                    <h4 class="text-primary mb-0">@Model.SalesCount</h4>
                                                    <small class="text-muted">Sales</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <h4 class="text-success mb-0">@Model.ViewCount</h4>
                                                <small class="text-muted">Views</small>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="text-center">
                                            <small class="text-muted">Created: @Model.CreatedAt.ToString("MMM dd, yyyy")</small><br>
                                            <small class="text-muted">Updated: @Model.UpdatedAt?.ToString("MMM dd, yyyy") ?? "Never"</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                    <div>
                                        <button type="button" class="btn btn-info me-2" onclick="previewProduct()">
                                            <i class="fas fa-eye"></i> Preview
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Update Product
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product? This action cannot be undone.</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> Deleting this product will also remove all associated images, reviews, and order history.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash me-1"></i>Delete Product
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentImages = [];
        let newImages = [];
        let imagesToDelete = [];

        $(document).ready(function() {
            loadCurrentImages();
            setupImageUpload();
            setupFormValidation();
            calculateSalePercentage();
        });

        function loadCurrentImages() {
            // Load existing product images
            // This would typically come from the server
            const productId = $('#Id').val();
            
            // Simulated current images - replace with actual server call
            currentImages = [
                { id: 1, url: '/images/products/sample1.jpg', isPrimary: true },
                { id: 2, url: '/images/products/sample2.jpg', isPrimary: false }
            ];
            
            displayCurrentImages();
        }

        function displayCurrentImages() {
            const container = $('#currentImagesList');
            container.empty();
            
            currentImages.forEach(function(image, index) {
                const imageHtml = `
                    <div class="col-6 mb-2" data-image-id="${image.id}">
                        <div class="position-relative">
                            <img src="${image.url}" class="img-fluid rounded" style="height: 80px; object-fit: cover; width: 100%;">
                            ${image.isPrimary ? '<span class="badge bg-primary position-absolute top-0 start-0 m-1">Primary</span>' : ''}
                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" onclick="removeCurrentImage(${image.id})">
                                <i class="fas fa-times"></i>
                            </button>
                            ${!image.isPrimary ? `<button type="button" class="btn btn-sm btn-outline-primary position-absolute bottom-0 start-0 m-1" onclick="setPrimaryImage(${image.id})">Set Primary</button>` : ''}
                        </div>
                    </div>
                `;
                container.append(imageHtml);
            });
        }

        function removeCurrentImage(imageId) {
            currentImages = currentImages.filter(img => img.id !== imageId);
            imagesToDelete.push(imageId);
            displayCurrentImages();
        }

        function setPrimaryImage(imageId) {
            currentImages.forEach(img => img.isPrimary = img.id === imageId);
            displayCurrentImages();
        }

        function setupImageUpload() {
            const uploadArea = $('#imageUploadArea');
            const fileInput = $('#imageInput');

            uploadArea.on('click', function() {
                fileInput.click();
            });

            uploadArea.on('dragover', function(e) {
                e.preventDefault();
                $(this).addClass('border-primary');
            });

            uploadArea.on('dragleave', function(e) {
                e.preventDefault();
                $(this).removeClass('border-primary');
            });

            uploadArea.on('drop', function(e) {
                e.preventDefault();
                $(this).removeClass('border-primary');
                const files = e.originalEvent.dataTransfer.files;
                handleFiles(files);
            });

            fileInput.on('change', function() {
                handleFiles(this.files);
            });
        }

        function handleFiles(files) {
            Array.from(files).forEach(function(file) {
                if (validateFile(file)) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = {
                            file: file,
                            url: e.target.result,
                            name: file.name
                        };
                        newImages.push(imageData);
                        displayImagePreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function validateFile(file) {
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            const maxSize = 5 * 1024 * 1024; // 5MB

            if (!allowedTypes.includes(file.type)) {
                alert('Please select a valid image file (JPG, PNG, WebP)');
                return false;
            }

            if (file.size > maxSize) {
                alert('File size must be less than 5MB');
                return false;
            }

            return true;
        }

        function displayImagePreview() {
            const container = $('#imagePreview');
            container.empty();
            
            newImages.forEach(function(image, index) {
                const imageHtml = `
                    <div class="col-6 mb-2">
                        <div class="position-relative">
                            <img src="${image.url}" class="img-fluid rounded" style="height: 80px; object-fit: cover; width: 100%;">
                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" onclick="removeNewImage(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                            <small class="position-absolute bottom-0 start-0 m-1 bg-dark text-white px-1 rounded">${image.name}</small>
                        </div>
                    </div>
                `;
                container.append(imageHtml);
            });
        }

        function removeNewImage(index) {
            newImages.splice(index, 1);
            displayImagePreview();
        }

        function calculateSalePercentage() {
            const regularPrice = parseFloat($('#Price').val()) || 0;
            const salePrice = parseFloat($('#SalePrice').val()) || 0;
            const isOnSale = $('#IsOnSale').is(':checked');
            
            if (isOnSale && regularPrice > 0 && salePrice > 0 && salePrice < regularPrice) {
                const percentage = Math.round(((regularPrice - salePrice) / regularPrice) * 100);
                $('#salePercent').text(percentage);
                $('#salePercentage').show();
            } else {
                $('#salePercentage').hide();
            }
        }

        function setupFormValidation() {
            $('#Price, #SalePrice').on('input', calculateSalePercentage);
            $('#IsOnSale').on('change', calculateSalePercentage);
            
            $('#editProductForm').on('submit', function(e) {
                e.preventDefault();
                
                if (validateForm()) {
                    updateProduct();
                }
            });
        }

        function validateForm() {
            let isValid = true;
            
            // Basic validation
            const requiredFields = ['Name', 'SKU', 'Price', 'StockQuantity'];
            requiredFields.forEach(function(field) {
                const value = $(`#${field}`).val().trim();
                if (!value) {
                    $(`#${field}`).addClass('is-invalid');
                    isValid = false;
                } else {
                    $(`#${field}`).removeClass('is-invalid');
                }
            });
            
            return isValid;
        }

        function updateProduct() {
            const formData = new FormData();
            
            // Add form fields
            const form = document.getElementById('editProductForm');
            const formElements = new FormData(form);
            for (let [key, value] of formElements.entries()) {
                formData.append(key, value);
            }
            
            // Add new images
            newImages.forEach(function(image, index) {
                formData.append(`NewImages`, image.file);
            });
            
            // Add images to delete
            imagesToDelete.forEach(function(imageId) {
                formData.append('ImagesToDelete', imageId);
            });
            
            // Add primary image info
            const primaryImage = currentImages.find(img => img.isPrimary);
            if (primaryImage) {
                formData.append('PrimaryImageId', primaryImage.id);
            }
            
            $.ajax({
                url: '/Admin/UpdateProduct',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        toastr.success('Product updated successfully!');
                        window.location.href = '/Admin/Products';
                    } else {
                        toastr.error(response.message || 'Failed to update product');
                    }
                },
                error: function() {
                    toastr.error('An error occurred while updating the product');
                }
            });
        }

        function deleteProduct() {
            $('#deleteModal').modal('show');
        }

        function confirmDelete() {
            const productId = $('#Id').val();
            
            $.ajax({
                url: `/Admin/DeleteProduct/${productId}`,
                type: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        toastr.success('Product deleted successfully!');
                        window.location.href = '/Admin/Products';
                    } else {
                        toastr.error(response.message || 'Failed to delete product');
                    }
                },
                error: function() {
                    toastr.error('An error occurred while deleting the product');
                }
            });
            
            $('#deleteModal').modal('hide');
        }

        function previewProduct() {
            const productId = $('#Id').val();
            window.open(`/Products/Details/${productId}`, '_blank');
        }
    </script>
}