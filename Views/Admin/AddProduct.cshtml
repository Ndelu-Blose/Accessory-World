@model AccessoryWorld.ViewModels.AddProductViewModel
@{
    ViewData["Title"] = "Add Product";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
<style>
    .image-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .image-upload-area:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    
    .image-upload-area.dragover {
        border-color: #28a745;
        background-color: #d4edda;
    }
    
    .image-preview {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        margin: 10px;
        position: relative;
        display: inline-block;
    }
    
    .image-preview img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
    }
    
    .image-preview .remove-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 12px;
        cursor: pointer;
    }
    
    .promotion-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    
    .feature-badges .form-check {
        margin-bottom: 0.5rem;
    }
    
    .price-input-group {
        position: relative;
    }
    
    .price-input-group .input-group-text {
        background: #e9ecef;
        border-right: none;
    }
    
    .price-input-group .form-control {
        border-left: none;
    }
</style>
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>Add New Product
                    </h4>
                </div>
                
                <form asp-action="AddProduct" method="post" enctype="multipart/form-data" id="addProductForm">
                    <div class="card-body">
                        <div class="row">
                            <!-- Basic Information -->
                            <div class="col-lg-8">
                                <h5 class="mb-3">Basic Information</h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="Name" class="form-label">Product Name *</label>
                                            <input asp-for="Name" class="form-control" placeholder="Enter product name">
                                            <span asp-validation-for="Name" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="SKUCode" class="form-label">SKU Code</label>
                                            <input asp-for="SKUCode" class="form-control" placeholder="Auto-generated if empty">
                                            <span asp-validation-for="SKUCode" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="CategoryId" class="form-label">Category *</label>
                                            <select asp-for="CategoryId" class="form-select">
                                                <option value="">Select Category</option>
                                                @foreach (var category in (ViewBag.Categories as IEnumerable<dynamic>) ?? Enumerable.Empty<dynamic>())
                                                {
                                                    <option value="@category.Id">@category.Name</option>
                                                }
                                            </select>
                                            <span asp-validation-for="CategoryId" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="BrandId" class="form-label">Brand *</label>
                                            <select asp-for="BrandId" class="form-select">
                                                <option value="">Select Brand</option>
                                                @foreach (var brand in (ViewBag.Brands as IEnumerable<dynamic>) ?? Enumerable.Empty<dynamic>())
                                                {
                                                    <option value="@brand.Id">@brand.Name</option>
                                                }
                                            </select>
                                            <span asp-validation-for="BrandId" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label asp-for="Description" class="form-label">Description</label>
                                    <textarea asp-for="Description" class="form-control" rows="4" placeholder="Enter product description"></textarea>
                                    <span asp-validation-for="Description" class="text-danger"></span>
                                </div>
                                
                                <!-- Pricing Section -->
                                <div class="promotion-section">
                                    <h6 class="mb-3"><i class="fas fa-tags me-2"></i>Pricing & Promotions</h6>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label asp-for="Price" class="form-label">Regular Price *</label>
                                                <div class="input-group price-input-group">
                                                    <span class="input-group-text">R</span>
                                                    <input asp-for="Price" class="form-control" placeholder="0.00" step="0.01">
                                                </div>
                                                <span asp-validation-for="Price" class="text-danger"></span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="CompareAtPrice" class="form-label">Compare At Price</label>
                                                <div class="input-group price-input-group">
                                                    <span class="input-group-text">R</span>
                                                    <input name="CompareAtPrice" id="CompareAtPrice" class="form-control" placeholder="0.00" step="0.01">
                                                </div>
                                                <small class="text-muted">Original price for showing discounts</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="SalePrice" class="form-label">Sale Price</label>
                                                <div class="input-group price-input-group">
                                                    <span class="input-group-text">R</span>
                                                    <input name="SalePrice" id="SalePrice" class="form-control" placeholder="0.00" step="0.01">
                                                </div>
                                                <small class="text-muted">Leave empty if not on sale</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input name="IsOnSale" id="IsOnSale" class="form-check-input" type="checkbox">
                                        <label class="form-check-label" for="IsOnSale">
                                            <i class="fas fa-percentage me-1"></i>Product is on sale
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Inventory Section -->
                                <h6 class="mb-3"><i class="fas fa-warehouse me-2"></i>Inventory</h6>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="StockQuantity" class="form-label">Stock Quantity *</label>
                                            <input asp-for="StockQuantity" class="form-control" placeholder="0">
                                            <span asp-validation-for="StockQuantity" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="LowStockThreshold" class="form-label">Low Stock Threshold</label>
                                            <input asp-for="LowStockThreshold" class="form-control" placeholder="5">
                                            <span asp-validation-for="LowStockThreshold" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Product Features & Images -->
                            <div class="col-lg-4">
                                <!-- Product Images -->
                                <h5 class="mb-3">Product Images</h5>
                                
                                <div class="image-upload-area" id="imageUploadArea">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                    <p class="mb-2">Drag & drop images here or click to browse</p>
                                    <small class="text-muted">Supports: JPG, PNG, WebP (Max 5MB each)</small>
                                    <input type="file" id="imageInput" name="ProductImages" multiple accept="image/*" style="display: none;">
                                </div>
                                
                                <div id="imagePreviewContainer" class="mt-3"></div>
                                
                                <!-- Feature Badges -->
                                <div class="mt-4">
                                    <h6 class="mb-3"><i class="fas fa-star me-2"></i>Product Features</h6>
                                    
                                    <div class="feature-badges">
                                        <div class="form-check">
                                            <input name="IsFeatured" id="IsFeatured" class="form-check-input" type="checkbox">
                                            <label class="form-check-label" for="IsFeatured">
                                                <i class="fas fa-star text-warning me-1"></i>Featured Product
                                            </label>
                                        </div>
                                        
                                        <div class="form-check">
                                            <input name="IsNew" id="IsNew" class="form-check-input" type="checkbox">
                                            <label class="form-check-label" for="IsNew">
                                                <i class="fas fa-sparkles text-info me-1"></i>New Product
                                            </label>
                                        </div>
                                        
                                        <div class="form-check">
                                            <input name="IsHot" id="IsHot" class="form-check-input" type="checkbox">
                                            <label class="form-check-label" for="IsHot">
                                                <i class="fas fa-fire text-danger me-1"></i>Hot Product
                                            </label>
                                        </div>
                                        
                                        <div class="form-check">
                                            <input name="IsTodayDeal" id="IsTodayDeal" class="form-check-input" type="checkbox">
                                            <label class="form-check-label" for="IsTodayDeal">
                                                <i class="fas fa-clock text-success me-1"></i>Today's Deal
                                            </label>
                                        </div>
                                        
                                        <div class="form-check">
                                            <input name="IsBestSeller" id="IsBestSeller" class="form-check-input" type="checkbox">
                                            <label class="form-check-label" for="IsBestSeller">
                                                <i class="fas fa-trophy text-warning me-1"></i>Best Seller
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Product Status -->
                                <div class="mt-4">
                                    <h6 class="mb-3"><i class="fas fa-toggle-on me-2"></i>Status</h6>
                                    
                                    <div class="form-check form-switch">
                                        <input asp-for="IsActive" class="form-check-input" type="checkbox" checked>
                                        <label asp-for="IsActive" class="form-check-label">
                                            Active Product
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="d-flex justify-content-between">
                            <a href="@Url.Action("Products", "Admin")" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Back to Products
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2" id="previewBtn">
                                    <i class="fas fa-eye me-1"></i>Preview
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Add Product
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Image upload functionality
            const imageUploadArea = $('#imageUploadArea');
            const imageInput = $('#imageInput');
            const previewContainer = $('#imagePreviewContainer');
            let uploadedImages = [];
            
            // Click to upload
            imageUploadArea.on('click', function() {
                imageInput.click();
            });
            
            // Drag and drop
            imageUploadArea.on('dragover', function(e) {
                e.preventDefault();
                $(this).addClass('dragover');
            });
            
            imageUploadArea.on('dragleave', function(e) {
                e.preventDefault();
                $(this).removeClass('dragover');
            });
            
            imageUploadArea.on('drop', function(e) {
                e.preventDefault();
                $(this).removeClass('dragover');
                
                const files = e.originalEvent.dataTransfer.files;
                handleImageFiles(files);
            });
            
            // File input change
            imageInput.on('change', function() {
                handleImageFiles(this.files);
            });
            
            function handleImageFiles(files) {
                Array.from(files).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        if (file.size <= 5 * 1024 * 1024) { // 5MB limit
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                addImagePreview(e.target.result, file.name);
                            };
                            reader.readAsDataURL(file);
                            uploadedImages.push(file);
                        } else {
                            alert('Image size should be less than 5MB: ' + file.name);
                        }
                    }
                });
            }
            
            function addImagePreview(src, name) {
                const preview = $(`
                    <div class="image-preview">
                        <img src="${src}" alt="${name}">
                        <button type="button" class="remove-btn" onclick="removeImage(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `);
                previewContainer.append(preview);
            }
            
            // Auto-calculate sale percentage
            $('#CompareAtPrice, #SalePrice').on('input', function() {
                const comparePrice = parseFloat($('#CompareAtPrice').val()) || 0;
                const salePrice = parseFloat($('#SalePrice').val()) || 0;
                
                if (comparePrice > 0 && salePrice > 0 && salePrice < comparePrice) {
                    $('#IsOnSale').prop('checked', true);
                } else {
                    $('#IsOnSale').prop('checked', false);
                }
            });
            
            // Form validation
            $('#addProductForm').on('submit', function(e) {
                const name = $('#Name').val().trim();
                const price = parseFloat($('#Price').val()) || 0;
                const stock = parseInt($('#StockQuantity').val()) || 0;
                
                if (!name) {
                    alert('Product name is required');
                    e.preventDefault();
                    return;
                }
                
                if (price <= 0) {
                    alert('Price must be greater than 0');
                    e.preventDefault();
                    return;
                }
                
                if (stock < 0) {
                    alert('Stock quantity cannot be negative');
                    e.preventDefault();
                    return;
                }
            });
        });
        
        function removeImage(button) {
            $(button).closest('.image-preview').remove();
        }
    </script>
}